# Node-HW-SHRI 

### Установка

У вас должна быть node js v12.12.0 версии, иначе некоторые зависимости которые я тяну просто не будут работать (
к тому же я столкнулся с неприятным [багом](https://github.com/facebook/create-react-app/issues/8900)
Поэтому убедительная просьба, звучит достаточно убедительно? Просьба поставить именно v12.12.0 

если ваша версия не схожа с моей, воспользуйтесь nvm, крайне удобная и полезная штука

для [Linux/macOS](https://github.com/nvm-sh/nvm)

## Запуск

### Server Client

1) Для начала введите в консоли 

    ```
      cd server
      npm ci

    ```
    так же если вы захотите запустить фронтенд из папки front, то незабудьте установить все зависимости  так же с помощью npm ci

2) Вам нужно создать файл в ./server .env

    В самом файле сделать такую запись 

    ```
    TOKEN=eyJhbasdasdGciOasdasdiJIUzI1NiIsInR5cCI6asasdIkpXVCJ9
    PORT=3000
    PUBLICKEY=BJdnYn_COyWs3YrW
    PRIVATEKEY=sZ6ta-SGZUomDJ
    ``` 
    сам токен я отправлю с ссылкой на репозиторий, хотя не уверен что он вам нужен, но все же. Если вы хотите запустить сервер с клиентом(на сервере уже имеется простенький ssr), то смените PORT на 3001 и запускайте react вместе с сервером

3)  Запуск локального сервера  

    ``` 
    npm start
    ```
    Eсли вы хотите запустить сервер в режиме разработки

    ```
    npm run dev
    ```

### Servers build

Это нужно для сборки проектов и проверки web push api.

Для начала вам нужно скачать [репозеторий](https://github.com/MoksS/Shri-infra)

желательно предварительно запустить клиент сервер и создать новые билды в очереди для сборки с помощью ребилд, или в настройках укажите то что вы сами хотите протестировать

после запускаем  2 сервер

1) 
    ```
    cd server
    npm start
    ```

2)
    ```
    cd agent
    npm start
    ```

### Client React (опционально, можно пропустить, в принципе вам хватит только сервера)
1) Из коря проекта введите в консоль

    ``` 
    cd front
    npm ci
    ```

2) Для запуска

    ``` 
    npm start
    ```    
    
    Чтобы собрать билд

    ```
    npm run build
    ```

### Выбор стратегии обосновать в readme

Я выбрал стратегию ***Network First*** с таймаутом в качестве ограничения по времени загрузки.

Если запрос не укладывается в 400мс, то данные берутся из кеша. После того как даные взялись из кеша, кеш автоматически снова делает запрос и обновляется.

Если запрос не укладывется в 400мс и данных в кеше нету, то сервер ожидает конца запроса выводит ответ пользователю и полученные данные сразу сохраняет в кеш.
По моему мнению это самый оптимальный вариант.


При ***Network only*** пользователь может достаточно долго ждать получение контента, но зато он всегда будет "свежий")))) что не круто сказывается по перфомансу. В случае неудачи, отдает данные из кеша. По хорошему для всего нашего приложения больше подходит именно эта стратеги, но я хотел пострадать)

В случае ***Only cache** сайт будет максимально производительный в скорости загрузки, но в нашем приложении данные часто обновляются, и чтобы получить последнюю версию контента, приходится каждый раз обновляться.


### Проблемы

При первой инициализации сервис воркера в кеш добавляется вся статика, кроме html, его просто нет) Естественно запросы к api тоже не кешируются. Чтобы получить возможность полностью перейти в офлайн режим, после инициализации воркера, надо еще 1 раз перезагрузить страницу.

с ***Network First*** все круто и классно, но у нас есть запрос получения логов, при получении которых нужно ожидать 3 секунды (специально усложнили задание со стороны api бд яндекса)
Из-за чего, когда мы делаем ребилд или добавление в очередь по комиту, нас сразу перекидывает в build details, и там сервер кеширует невалидные логи, после того как к нам приходит уведомление о завершении сборки, мы переходим на саму сборку и чтобы получить последнии данные, нужно перезагрузить страницу(( Это происходит один раз, потом логи сохраняются в кеш не только на фронте но и на сервере.

Теперь что касается web push api, я не смог настроить иконки((, а так же переход на страницу по клику на уведомление. Чего только не перепробовал, ничего не получилось. Не думаю что это проблема в linux (ubuntu 19.10), но вдруг у вас иконки заработают. 
И еще, на сервере я не сделал локальную базу данных для клиентов подписанных на push уведомления, сейчас у меня там стоит костыль в лице перменной shitDB. Позже перепишу. 

На этом все, спасибо за внимание, надеюсь не сильно замучал или замучаю со своим кодом) Искренне надеюсь, что все заработает без танцев с бубном) 

Критикуйте ни в чем себе не отказывайте   (￣^￣)ゞ	